
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>José Galisteo Ruiz</title>
  <meta name="author" content="Jose Galisteo Ruiz">

  
  <meta name="description" content="Este post va sobre mi gema
activerecord-preload_query
y otras maneras de hacer lo mismo. Activerecord nos provee los métodos preload, eager_load e &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ceritium.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="José Galisteo Ruiz" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-63575316-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">José Galisteo Ruiz</a></h1>
  
    <h2>¯\_(ツ)_/¯</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  
    <li><a href="mailto:ceritium@gmail.com" rel="email" title="contact via email">ceritium@gmail.com</a></li>
  
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="ceritium.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/04/activerecord-preload-query/">activerecord-preload_query</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-08-04T22:55:41+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:55 pm</span></time>
        
           | <a href="/blog/2016/08/04/activerecord-preload-query/#disqus_thread"
             data-disqus-identifier="http://ceritium.github.io/blog/2016/08/04/activerecord-preload-query/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Este post va sobre mi gema
<a href="https://github.com/ceritium/activerecord-preload_query">activerecord-preload_query</a>
y otras maneras de hacer lo mismo.</p>

<p>Activerecord nos provee los métodos <code>preload</code>, <code>eager_load</code> e <code>includes</code> para precargar
relaciones y evitar hacer N+1 queries a la base de datos cuando queremos acceder
a esta. También nos provee de <code>counter_cache</code>, el cual está muy bien, pero está
muy imitado.</p>

<p>Pero que pasa si tenemos algunos cálculos mas complicados? Imaginemos que
tenemos el siguiente código:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Category</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:products</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:category</span><span class="p">,</span> <span class="ss">counter_cache</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Gracias a <code>counter_cache</code> podemos hacer algo así:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Category</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">category</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">p</span> <span class="n">category</span><span class="o">.</span><span class="n">products_count</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y solo se hará una sola llamada.</p>

<p>Pero y si queremos saber por alguna razón el stock total de cada categoría?
Imaginemos que <code>Product</code> tiene el atributo <code>stock</code>.</p>

<p>En la categoría podremos añadir un método <code>products_stock</code> como este:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">products_stock</span>
</span><span class='line'>  <span class="n">products</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="ss">:stock</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>De esta manera, tendremos de nuevo el problema del N+1.</p>

<h2>Solución con joins</h2>

<p>Para evitarlo podríamos optar por algo como:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="vi">@categories</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;*, sum(products.stock) as products_stock&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:products</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Esto soluciona el problema del N+1, pero estamos sobrescribiendo el <code>select</code>,
entonces a <code>@categories</code> no podremos enviarle muchos métodos de activerecord
porque no estarán disponibles los campos que el espera.</p>

<p>Un ejemplo sencillo es con <code>@categories.count</code>
y si en vez de ser <code>Category</code> lo que precede a <code>select</code> fuese un &ldquo;scope&rdquo; mucho más
complicado como podría ser en el caso del <code>scope</code> producido por una búsqueda
compleja seguramente acabaríamos rompiendo la <code>query</code>.</p>

<p>Además que incluso con este sencillo caso, <code>@categories.count</code> acaba dando un
error al no estar presentes los campos que se esperaban, porque hemos sobreescrito el
<code>select</code>.</p>

<p>Otro problema a tener en cuenta, pero no el principal es hacer <code>joins</code> de tablas
muy grandes.</p>

<h2>Consulta a parte</h2>

<p>Para evitar los problemas de sobreescribir el <code>select</code>, lo mejor es hacer la consulta
a parte, por ejemplo:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">categories</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:foo</span><span class="p">,</span> <span class="ss">:bar</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;whatever = foo&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">products_stock</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;*, sum(products.stock) as products_stock&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:products</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="o">[</span><span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">products_stock</span><span class="o">]</span><span class="p">}</span><span class="o">.</span><span class="n">to_h</span>
</span><span class='line'>
</span><span class='line'><span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">category</span><span class="o">|</span>
</span><span class='line'>  <span class="n">category</span><span class="o">.</span><span class="n">define_singleton_method</span> <span class="ss">:products_stock</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="n">products_stock</span><span class="o">[</span><span class="n">category</span><span class="o">.</span><span class="n">id</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Con preload_query</h2>

<p>Con <code>preload_query</code> es básicamente igual, pero interceptando el método de
ActiveRecord que se encarga de hacer la consulta, así no llamaremos a la base de
datos hasta el  momento en el que sea necesario.</p>

<p>Ejemplo de uso básico:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Category</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:products</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">sum_stock</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
</span><span class='line'>      <span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;categories.id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:products</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;categories.id, sum(products.stock) AS sum_stock&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Category</span><span class="o">.</span><span class="n">preload_query</span><span class="p">(</span><span class="ss">:sum_stock</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:sum_stock</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>A la clase <code>Category</code> puede que nos interese implementarle el método <code>sum_stock</code>
para cuando no se hace un preload.</p>

<p>Por ejemplo:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Category</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:products</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">preloaded_sum_stock</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
</span><span class='line'>      <span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;categories.id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:products</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;categories.id, sum(products.stock) AS preloaded_sum_stock&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">sum_stock</span>
</span><span class='line'>    <span class="n">try</span><span class="p">(</span><span class="ss">:preloaded_sum_stock</span><span class="p">)</span> <span class="o">||</span> <span class="n">products</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="ss">:stock</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Category</span><span class="o">.</span><span class="n">preload_query</span><span class="p">(</span><span class="ss">:sum_stock</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:sum_stock</span><span class="p">)</span>
</span><span class='line'><span class="no">Category</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:sum_stock</span><span class="p">)</span>
</span><span class='line'><span class="no">Category</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">sum_stock</span>
</span></code></pre></td></tr></table></div></figure>


<p>Me gustaría pensar un DSL para implementar este último ejemplo de forma mas
sencilla, pero de momento no se me ocurre :P</p>

<h2>Gemas similares</h2>

<p>Estas gemas hace algo parecido, pero solo se encargan de los <code>counts</code>, quizás
para ti sea suficiente.</p>

<ul>
<li><a href="https://github.com/k0kubun/activerecord-precount">https://github.com/k0kubun/activerecord-precount</a></li>
<li><a href="https://github.com/smathieu/preload_counts">https://github.com/smathieu/preload_counts</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/07/heroku-y-memcached-local/">Heroku y Memcached local</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-07T15:41:59+02:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>3:41 pm</span></time>
        
           | <a href="/blog/2016/07/07/heroku-y-memcached-local/#disqus_thread"
             data-disqus-identifier="http://ceritium.github.io/blog/2016/07/07/heroku-y-memcached-local/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>La única opción &ldquo;oficial&rdquo; para usar memcaché en Heroku es usar el addon
Memcachier o algún otro servicio externo, lo cual está genial pero a veces no es
lo mejor, todo dependerá de nuestra aplicación y la estrategia de <em>caching</em> que
usemos.</p>

<p>En mi caso quiero usar memcached para <em>cachear</em> partes de vistas basándome en el
<code>updated_at</code> de los objetos, una estrategia super sencilla. Además en los listados
puedo hacer desde 10 hasta cientos de peticiones a <em>Memcached</em> pues son caches de
fragmentos anidados.</p>

<p>El problema aquí está en la latencia, por poca que sea, multiplica eso por 100 o
500 peticiones. Lo ideal para mi caso sería tener <em>Memcached</em> corriendo en la
misma maquina que mi aplicación.</p>

<h2>Como ejecutar Memcached local en Heroku dynos</h2>

<p>Añade <code>https://github.com/Americastestkitchen/heroku-buildpack-apt</code> a tu app.
Puedes hacerlo desde consola o la interfaz de <em>Heroku</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ heroku buildpacks:add https://github.com/Americastestkitchen/heroku-buildpack-apt</span></code></pre></td></tr></table></div></figure>


<p>Crea un fichero <code>Aptfile</code> con los paquetes a instalar, en este caso solo
Memcached.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Aptfile
</span><span class='line'>
</span><span class='line'>memcached</span></code></pre></td></tr></table></div></figure>


<p>Cambia tu <code>Procfile</code> para que ejecute <code>memcached</code> y tu aplicación, en mi caso hice:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Procfile
</span><span class='line'>web: memcached -m 64 & bundle exec puma -C config/puma.rb
</span><span class='line'>
</span><span class='line'># -m es la cantidad de ram</span></code></pre></td></tr></table></div></figure>


<p>Con esto cuando vuelvas a desplegar tendrás disponible <code>memcached</code> en cada
<em>dyno</em> dedicado a web. Los parametros son los que vienen por defecto <code>127.0.0.1:11211</code>.</p>

<h2>Cosas a tener en cuenta:</h2>

<p><strong>La cantitdad de RAM disponible</strong></p>

<p>Puedes usar
<a href="https://devcenter.heroku.com/articles/log-runtime-metrics"><code>log-runtime-metrics</code></a> para
monitorizarlo o las estadisticas que ofrece Heroku en el dashboard, pero estas
solo están disponibles para aplicaciones que usan dynos a partir de
<code>standar-1x</code>. Necesitas saber cuánta <em>RAM</em> consume tu app normalmente, cosa que
puedes ver con NewRelic (gratis) y decidir que cantidad le dedicas a Memcached.</p>

<p><strong>Una instancia de Memcached por dyno</strong></p>

<p>Esto es lo que buscábamos al fin y al cabo, si quieres memcached para tus
workers tendrás que hacer lo mismo que para web. Si tienes varios dynos
corriendo cada uno tendrá su propia caché, por lo que tu aplicación debe estar
preparada para ello. Si necesitas una sola instancía de Memcached entonces lo
mejor es que uses un servicio externo.</p>

<p><strong>Volatilidad</strong></p>

<p>Cada vez que <em>despliegues</em> y posiblemente cada vez que hagas un <em>restart</em> perderás
toda la caché. Por esta razón no es buena idea hacer lo mismo para Redis, a
menos que uses Redis única y exclusivamente para caché.</p>

<h2>Las pruebas</h2>

<p>Por último una muestra de mis logs antes y después.</p>

<p><img src="/images/memcached3.png" title="Antes y después" ></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/22/activerecord-y-memoria/">ActiveRecord, find_each y uncached</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-05-22T18:24:56+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>6:24 pm</span></time>
        
           | <a href="/blog/2016/05/22/activerecord-y-memoria/#disqus_thread"
             data-disqus-identifier="http://ceritium.github.io/blog/2016/05/22/activerecord-y-memoria/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Si tenemos que recorrer coleciones muy grandes de ActiveRecord deberíamos usar
<code>find_each</code> o <code>find_in_batches</code>, hasta aquí ninguna novedad, pero el otro día me
di cuenta de que mis workers de sidekiq consumían muchísima memoria, el problema
es que AR cache los objetos que devuelve el <code>find_each</code>.</p>

<p>La solución para evitar esto pasa por usar el método <a href="http://api.rubyonrails.org/classes/ActiveRecord/QueryCache/ClassMethods.html#method-i-uncached">uncached</a>.</p>

<p>Ejemplo:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">uncached</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">scope</span><span class="o">.</span><span class="n">find_each</span><span class="p">(</span><span class="ss">batch_size</span><span class="p">:</span> <span class="mi">1000</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">tweet</span><span class="o">|</span>
</span><span class='line'>    <span class="n">gz</span><span class="o">.</span><span class="n">write</span> <span class="n">tweet</span><span class="o">.</span><span class="n">to_csv</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/03/28/diy-plotter-cnc/">DIY plotter CNC</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-03-28T19:03:02+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>7:03 pm</span></time>
        
           | <a href="/blog/2016/03/28/diy-plotter-cnc/#disqus_thread"
             data-disqus-identifier="http://ceritium.github.io/blog/2016/03/28/diy-plotter-cnc/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Como proyecto para el puente de semana santa empecé un plotter CNC de bajo
coste, me basé en este
<a href="http://www.instructables.com/id/Mini-CNC-Plotter-Arduino-Based/">instructable</a>.</p>

<p>En el instructable ya viene casi todo detallado así que solo me queda daros
algunos consejos y agrupar en un repo todo el código.</p>

<p>El mini plotter usa dos lectores de CD o DVD, si no tenéis lo mejor es que los
compréis de segunda mano, yo he conseguido dos por menos de 5 euros.</p>

<p>En el tutorial explica como controlar los motores con arduino usando los chips <strong>L293D IC</strong>, pero para ahorrame cableado decidí usar una <a
rel="nofollow"
href="http://www.amazon.es/gp/product/B00PS0QPRY/ref=as_li_ss_tl?ie=UTF8&camp=3626&creative=24822&creativeASIN=B00PS0QPRY&linkCode=as2&tag=josegr-21">Motor
shield</a><img
src="http://ir-es.amazon-adsystem.com/e/ir?t=josegr-21&l=as2&o=30&a=B00PS0QPRY"
width="1" height="1" border="0" alt="" style="border:none !important; margin:0px
!important;" /> que ya la tenía por casa, esta es compatible con la <a href="https://github.com/adafruit/Adafruit-Motor-Shield-library">Adafruit Motor
Shield library</a>.</p>

<p>Si usas la librería Adafruit Motor Shield tendrás que cambiar un poco el código
que cargues a tu Arduino.</p>

<p>Este lo saqué de un comentario del propio tutorial, aquí os lo dejo un poco más
bonito.</p>

<script src="https://gist.github.com/ceritium/04521b4eeb70a305fcc3.js"></script>


<p>Para conectar los cables a los motores, creo que lo mejor es soldar directamente
los cables en los 4 puntos que hay expuestos, no trate de quitar el plastiquito,
así solo conseguiras cargartelo.</p>

<p>Y este es el plotter funcionando, aún sin el servo para levantar el boligrafo.</p>

<iframe width="100%" height="500px" src="https://www.youtube.com/embed/8Le7nVhrpY4" frameborder="0" allowfullscreen></iframe>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/06/postgres-after-upgrade-to-yosemite/">Postgres after upgrade to Yosemite</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-06T00:03:19+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:03 am</span></time>
        
           | <a href="/blog/2015/08/06/postgres-after-upgrade-to-yosemite/#disqus_thread"
             data-disqus-identifier="http://ceritium.github.io/blog/2015/08/06/postgres-after-upgrade-to-yosemite/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I recently upgraded to Yosemite after skip the reminder each day for the last
year&hellip;</p>

<p>Everything was fine, Mysql working, brew packages are OK, rbenv, ruby and Rails
stuff looks fine except <strong>Postgres</strong>.</p>

<p>Checking the logs I saw:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FATAL:  could not open directory "pg_tblspc": No such file or directory</span></code></pre></td></tr></table></div></figure>


<p>The solution was easy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /usr/local/var/postgres
</span><span class='line'>mkdir pg_tblspc pg_twophase pg_stat_tmp
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/29/instalar-qt4-en-ubuntu-14-dot-04/">Instalar QT4 en Ubuntu 14.04</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-29T22:40:16+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:40 pm</span></time>
        
           | <a href="/blog/2015/05/29/instalar-qt4-en-ubuntu-14-dot-04/#disqus_thread"
             data-disqus-identifier="http://ceritium.github.io/blog/2015/05/29/instalar-qt4-en-ubuntu-14-dot-04/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ubuntu 14.04 viene con QT5 por defecto lo cual está bien, pero a veces podemos
necesitar usar QT4 para trabajar con versiones de librerías o gemas
antiguas, como por ejemplo <code>capybara-webkit 0.12.1</code>. En algún momento habrá que
actualizarlo&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install -y build-essential
</span><span class='line'>$ sudo apt-get build-dep qt4-qmake
</span><span class='line'>
</span><span class='line'>$ wget http://download.qt.io/archive/qt/4.8/4.8.6/qt-everywhere-opensource-src-4.8.6.tar.gz
</span><span class='line'>$ tar -xzvf qt-everywhere-opensource-src-4.8.6.tar.gz
</span><span class='line'>$ cd qt-everywhere-opensource-src-4.8.6
</span><span class='line'>
</span><span class='line'># En el configure nos pedirá elegir entre la version open source o privada,
</span><span class='line'># yo elegí la open source.
</span><span class='line'>$ ./configure
</span><span class='line'>
</span><span class='line'># Esto llevará un buen rato
</span><span class='line'>$ make
</span><span class='line'>
</span><span class='line'>$ sudo make install</span></code></pre></td></tr></table></div></figure>


<p>Con esto ya tenemos QT4, pero al hacer por ejemplo <code>gem install capybara-webkit
-v 0.12.1</code> dirá que no encuentra <code>qmake</code> para QT4.</p>

<p>Yo lo que hice fue:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Guardo una copia de qmake
</span><span class='line'>
</span><span class='line'>$ sudo mv /usr/bin/qmake /usr/bin/qmake.old
</span><span class='line'>$ sudo /usr/local/Trolltech/Qt-4.8.6 /usr/bin/qmake</span></code></pre></td></tr></table></div></figure>


<p>Y con esto ya instala sin problemas.</p>

<p>Tengo pendiente para el lunes probar <code>qtchooser</code>, el cual parece mejor opción.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/28/arduino-modulo-rf-433mhz/">Arduino modulo RF 433Mhz</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-28T01:28:42+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:28 am</span></time>
        
           | <a href="/blog/2015/05/28/arduino-modulo-rf-433mhz/#disqus_thread"
             data-disqus-identifier="http://ceritium.github.io/blog/2015/05/28/arduino-modulo-rf-433mhz/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Para el proyecto de <a href="/blog/2015/05/28/arduino-modulo-rf-433mhz/">monitorización de mi pequeño huerto
urbano</a> necesito
comunicar dos módulos Arduino de forma inalámbrica, para eso tenemos distintas
opciones y dependiendo de las necesidades podremos usar un sistema u otro.</p>

<p>En mi caso, solo necesito enviar unos pocos datos a pocos metros, lo que viene
siendo desde mi balcón donde tengo un módulo hasta el router donde tengo el otro
conectado a Internet.</p>

<p>Para ello he usado un transmisor y un receptor de <strong>RF a 433Mhz</strong>. Lo más
interesante de estos módulos es su bajo coste y lo podemos encontrar fácilmente
en <a href="http://www.amazon.es/gp/product/B00Q6WKUOM/ref=as_li_ss_tl?ie=UTF8&camp=3626&creative=24822&creativeASIN=B00Q6WKUOM&linkCode=as2&tag=josegr-21">Amazon</a><img src="http://ir-es.amazon-adsystem.com/e/ir?t=josegr-21&l=as2&o=30&a=B00Q6WKUOM" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
 o <a href="http://www.dx.com/es/p/433mhz-rf-transmitter-receiver-link-kit-green-221225?Utm_rid=98434108&amp;Utm_source=affiliate#.VUFV2Nqqqko">DX.com</a> por menos de 5 euros.</p>

<p>Para usar estos módulos podemos usar la librería
<a href="https://github.com/kevinprince/VirtualWire">VirtualWire</a> la cual nos hará el
proceso mucho más sencillo.</p>

<p>Modulo emisor:</p>

<p><img src="/images/rf-433-emiter.jpg" title="RF 433 emiter" ></p>

<p>Conexiones:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Arduino     | Emisor
</span><span class='line'>----------- | ---------------
</span><span class='line'>5V          | VCC
</span><span class='line'>GND         | GND
</span><span class='line'>Digital 12  | DATA
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;VirtualWire.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Para el led</span>
</span><span class='line'>  <span class="n">pinMode</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Pin de escritura</span>
</span><span class='line'>  <span class="n">vw_set_tx_pin</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Velocidad de transferencia en Kbps</span>
</span><span class='line'>  <span class="c1">// debe ser la misma en el receptor</span>
</span><span class='line'>  <span class="n">vw_setup</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">loop</span><span class="p">(){</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Un mensaje cualquiera, podríamos preparar una cadena</span>
</span><span class='line'>  <span class="c1">// concatenando distintos valores de sensores.</span>
</span><span class='line'>  <span class="n">String</span> <span class="n">message</span> <span class="o">=</span>  <span class="s">&quot;hello world!&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Convertimos el string a un array char.</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">message</span><span class="p">.</span><span class="n">length</span><span class="p">()];</span>
</span><span class='line'>  <span class="n">message</span><span class="p">.</span><span class="n">toCharArray</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Iluminamos el led para indicar que estamos transmitiendo</span>
</span><span class='line'>  <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Enviamos el mensaje</span>
</span><span class='line'>  <span class="n">vw_send</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span class='line'>  <span class="c1">// Se mantiene en espera hasta que todo el mensaje se ha enviado</span>
</span><span class='line'>  <span class="n">vw_wait_tx</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Apagamos el led</span>
</span><span class='line'>  <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Simplemente esperamos un segundo</span>
</span><span class='line'>  <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Modulo receptor:</p>

<p><img src="/images/rf-433-receiver.jpg" title="RF 433 receiver" ></p>

<p>Conexiones:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Arduino     | Receptor
</span><span class='line'>----------- | -----------------------------------------
</span><span class='line'>5V          | VCC
</span><span class='line'>GND         | GND
</span><span class='line'>Digital 11  | DATA # Uno de los dos disponibles
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;VirtualWire.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">String</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Para el led</span>
</span><span class='line'>  <span class="n">pinMode</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Pin de lectura</span>
</span><span class='line'>  <span class="n">vw_set_rx_pin</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Velocidad de transferencia en Kbps</span>
</span><span class='line'>  <span class="c1">// debe ser la misma en el transmisor</span>
</span><span class='line'>  <span class="n">vw_setup</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Ponemos en escucha</span>
</span><span class='line'>  <span class="n">vw_rx_start</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// Inizializamos el buffer con las constantes definidas en VirtualWire</span>
</span><span class='line'>  <span class="kt">uint8_t</span> <span class="n">buf</span><span class="p">[</span><span class="n">VW_MAX_MESSAGE_LEN</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">uint8_t</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">VW_MAX_MESSAGE_LEN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">vw_get_message</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buflen</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Iluminamos el led para indicar que hay una transmisión entrante</span>
</span><span class='line'>    <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Leemos el buffer y lo volcamos en la variable data</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buflen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="kt">char</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Lo imprimimos por el puerto serie</span>
</span><span class='line'>    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Y apagamos el led</span>
</span><span class='line'>   <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Con todo enchufado y el código cargado en ambos módulos podremos ver los leds
parpadeando y por el puerto serie del receptor los mensajes que manda el emisor.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/27/monitorizar-huerto-urbano-con-arduino/">Monitorizar huerto urbano con Arduino</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-27T21:00:42+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:00 pm</span></time>
        
           | <a href="/blog/2015/04/27/monitorizar-huerto-urbano-con-arduino/#disqus_thread"
             data-disqus-identifier="http://ceritium.github.io/blog/2015/04/27/monitorizar-huerto-urbano-con-arduino/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A pesar de lo pequeñito de mi balcón desde hace unos meses me decidí a sembrar
algunas hortalizas y hierbas aromáticas en mi balcón. También desde hace unos
meses estoy trasteando mas que nunca con Arduino y como no podía ser de otra
manera me propuse monitorizar mi mini huerto con Arduino.</p>

<p>El proyecto se compone de dos partes:</p>

<ul>
<li><p>Modulo auto suficiente de medición encargado de tomar los datos del huerto y
que los envié al modulo receptor.</p></li>
<li><p>Modulo receptor de datos que se encarga de almacenar los datos y tratarlos.</p></li>
</ul>


<p>Objetivos:</p>

<p>El modulo de medición debería ser energeticamente autosuficiente, es decir,
alimentarse por energía solar y ser capaz de enviar datos al modulo receptor.</p>

<p>El modulo receptor estaría a cierta distancia y conectado a una fuente
eléctrica.</p>

<h2>Modulo de medición</h2>

<p>La idea es que cada modulo pueda medir al menos la humedad de varias zonas,
plantas, macetas&hellip; para transmitir los datos al receptor.</p>

<h3>Componentes</h3>

<ul>
<li>Arduino Nano</li>
<li>Placa <a href="http://www.seeedstudio.com/depot/LiPo-Rider-v13-p-2403.html">LipoRider</a></li>
<li>Panel solar de <a href="http://www.seeedstudio.com/depot/05W-Solar-Panel-55x70-p-632.html">0.5W</a></li>
<li><a href="http://www.amazon.es/gp/product/B00Q6WKUOM/ref=as_li_ss_tl?ie=UTF8&camp=3626&creative=24822&creativeASIN=B00Q6WKUOM&linkCode=as2&tag=josegr-21">Transmisor RF 433Mhz</a><img src="http://ir-es.amazon-adsystem.com/e/ir?t=josegr-21&l=as2&o=30&a=B00Q6WKUOM" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.amazon.es/gp/product/B00K67Z76O/ref=as_li_ss_tl?ie=UTF8&camp=3626&creative=24822&creativeASIN=B00K67Z76O&linkCode=as2&tag=josegr-21">Higrometro</a><img src="http://ir-es.amazon-adsystem.com/e/ir?t=josegr-21&l=as2&o=30&a=B00K67Z76O" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>


<h2>Modulo receptor</h2>

<p>Recibe las lecturas de cada transmisor y los envía por HTTP a algún servicio web
o almacena en la SD.</p>

<h3>Componentes</h3>

<p>Básico:</p>

<ul>
<li>Arduino Uno</li>
<li><a href="http://www.amazon.es/gp/product/B00Q6WKUOM/ref=as_li_ss_tl?ie=UTF8&camp=3626&creative=24822&creativeASIN=B00Q6WKUOM&linkCode=as2&tag=josegr-21">Transmisor RF 433Mhz</a><img src="http://ir-es.amazon-adsystem.com/e/ir?t=josegr-21&l=as2&o=30&a=B00Q6WKUOM" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>


<p>Opción A:</p>

<ul>
<li><a href="http://www.amazon.es/gp/product/B00CL59OJU/ref=as_li_ss_tl?ie=UTF8&camp=3626&creative=24822&creativeASIN=B00CL59OJU&linkCode=as2&tag=josegr-21">Placa Arduino con Ethernet Shield W5100</a><img src="http://ir-es.amazon-adsystem.com/e/ir?t=josegr-21&l=as2&o=30&a=B00CL59OJU" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
</ul>


<p>Opción B:</p>

<ul>
<li><a href="http://www.amazon.es/gp/product/B00CWX6UXY/ref=as_li_ss_tl?ie=UTF8&camp=3626&creative=24822&creativeASIN=B00CWX6UXY&linkCode=as2&tag=josegr-21">Reloj, modulo I2C DS1307</a><img src="http://ir-es.amazon-adsystem.com/e/ir?t=josegr-21&l=as2&o=30&a=B00CWX6UXY" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></li>
<li><a href="http://www.dx.com/es/p/spi-microsd-card-adapter-v0-9b-for-arduino-works-with-official-arduino-board-246784?Utm_rid=98434108&amp;Utm_source=affiliate#.VUFV2Nqqqko">Adaptador micro SD</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/29/swagger-docs-swagger-ui-y-tests-de-integracion/">Swagger Docs, Swagger UI y tests de integración</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-29T20:52:36+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:52 pm</span></time>
        
           | <a href="/blog/2015/03/29/swagger-docs-swagger-ui-y-tests-de-integracion/#disqus_thread"
             data-disqus-identifier="http://ceritium.github.io/blog/2015/03/29/swagger-docs-swagger-ui-y-tests-de-integracion/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>En <a href="https://apidemic.co">Apidemic</a> estoy usando <a href="https://github.com/richhollis/swagger-docs">Swagger Docs</a> para generar la documentación swagger de la <em>API</em> interna y Swagger UI para visualizarla.</p>

<p>La vista por defecto de Swagger UI la he personalizado un poco para añadirle un
campo para la <em>API key</em>, pero si estás logado esta no es necesaria.</p>

<p>Todas estas características quería cubrirlas con <em>tests</em> de integración, pero
tenía el problema de que los <em>swagger docs</em> se generan con una tarea <em>rake</em> y alguno parámetros como el <code>base_path</code> cambiaban en cada entorno. Además en los tests de integración el puerto cambia cada vez.</p>

<p>Así prepare los tests:</p>

<figure class='code'><figcaption><span>config/initializers/swagger_docs.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Swagger</span><span class="o">::</span><span class="no">Docs</span><span class="o">::</span><span class="no">Config</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">transform_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">api_version</span><span class="p">)</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">/docs/</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Swagger</span><span class="o">::</span><span class="no">Docs</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">register_apis</span><span class="p">({</span>
</span><span class='line'>  <span class="s2">&quot;1.0&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:api_extension_type</span> <span class="o">=&gt;</span> <span class="ss">:json</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:base_path</span> <span class="o">=&gt;</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
</span><span class='line'><span class="c1"># continue...</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">test</span> <span class="s1">&#39;foo&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">visit</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">(</span><span class="n">current_url</span><span class="p">)</span>
</span><span class='line'>  <span class="n">base_path</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stubs</span><span class="p">(</span><span class="ss">:host</span><span class="p">)</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Swagger</span><span class="o">::</span><span class="no">Docs</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">registered_apis</span><span class="o">[</span><span class="s2">&quot;1.0&quot;</span><span class="o">][</span><span class="ss">:base_path</span><span class="o">]</span> <span class="o">=</span> <span class="n">base_path</span>
</span><span class='line'>  <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s2">&quot;swagger:docs&quot;</span><span class="o">].</span><span class="n">invoke</span>
</span><span class='line'>  <span class="c1"># continue...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/28/tutum/">Tutum</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-28T01:48:42+01:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:48 am</span></time>
        
           | <a href="/blog/2015/03/28/tutum/#disqus_thread"
             data-disqus-identifier="http://ceritium.github.io/blog/2015/03/28/tutum/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>El otro día casi por casualidad llegué a la web de
<a href="https://www.tutum.co/">Tutum.co</a>.</p>

<p>Tutum se define como &ldquo;Docker Platform for Devs and Ops&rdquo;, yo lo veo como un
<strong>Marathon</strong> pero mucho más sencillo y sin necesidad de tener más infraestructura
que los servidores sobre los que quieres correr tus <em>dockers</em>.</p>

<p>A golpe de click puedes lanzar nodos sobre Amazon Ec2, Digital Ocean, Azure o
Softlayer, eliges la región, el tamaño, el numero de maquinas y las <em>taggeas</em>
para poder decirle a los servicios que levantes que vayan a un servidor o a
otro.</p>

<p>Lo mejor de todo es la API, gracias a la cual se me ha ocurrido montar un pequeño
sistema de integración continua <em>as a service</em>, ya se que hay muchos, pero es un
reto interesante.</p>

<p>Mientras sigan en beta será totalmente gratuito y los que se registren mientras
tanto tendrán una cuenta gratuita para siempre.</p>

<p>Si no sabes que es Docker o Marathon puedes seguir estos enlaces:</p>

<ul>
<li><a href="https://mesosphere.github.io/marathon/">Marathon</a></li>
<li><a href="https://www.docker.com/">Docker</a></li>
</ul>


<p>De todas formas dentro de Tutum puedes encontrar <a href="https://support.tutum.co/support/solutions/5000042949">mucha</a> <a href="https://learn.tutum.co/">documentación</a> sobre Tutum o sobre Docker en general. Mi recomendación además de que pruebes Docker es que trates de seguir algún tutorial sencillo del servicio.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/08/04/activerecord-preload-query/">activerecord-preload_query</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/07/heroku-y-memcached-local/">Heroku y Memcached local</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/22/activerecord-y-memoria/">ActiveRecord, find_each y uncached</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/28/diy-plotter-cnc/">DIY plotter CNC</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/06/postgres-after-upgrade-to-yosemite/">Postgres after upgrade to Yosemite</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/ceritium">@ceritium</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'ceritium',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Jose Galisteo Ruiz -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ceritiumblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
